{% extends "base.html" %}
{% block title %}Add Cashflow{% endblock %}
{% block page_title %}Add Cashflow{% endblock %}

{% block content %}
    <div class="row">
        <div class="col-md-12">
            <div class="card p-3">
                <form id="cashflowForm">
                    <label class="form-label">Category</label>
                    <select id="category" class="form-select" required>
                        {% for c in categories %}
                            <option value="{{ c.id }}" data-name="{{ c.name }}">{{ c.name }}</option>
                        {% endfor %}
                    </select>

                    <label class="form-label mt-2">Description</label>
                    <input class="form-control" id="description">

                    <label class="form-label mt-2">Date &amp; Time</label>
                    <input type="datetime-local" class="form-control" id="cashflow_date" required>

                    <hr>

                    <div id="productFields" class="d-none">
                        <div id="productList"></div>
                        
                        <button type="button" class="btn btn-sm btn-secondary mt-2" id="addProductBtn">
                            + Add Product
                        </button>
                    </div>

                    <label class="form-label mt-2">Total Amount</label>
                    <input type="number" step="0.01" id="amount" class="form-control" required>

                    <button class="btn btn-primary mt-3 w-100">Save</button>
                </form>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
    <script>
    const products = {{ products|tojson }};
    let productCounter = 0;
    let selectedProducts = [];

    // Set datepicker default to current local datetime
    (function setDefaultDate() {
        const now = new Date();
        // Format: YYYY-MM-DDTHH:MM (required by datetime-local input)
        const pad = n => String(n).padStart(2, '0');
        const localISO = `${now.getFullYear()}-${pad(now.getMonth() + 1)}-${pad(now.getDate())}T${pad(now.getHours())}:${pad(now.getMinutes())}`;
        document.getElementById('cashflow_date').value = localISO;
    })();

    // 1. Show/hide product fields based on category name
    document.getElementById('category').addEventListener('change', e => {
        const selectedOption = e.target.options[e.target.selectedIndex];
        const categoryName = selectedOption.dataset.name.toLowerCase();
        
        const isProductPurchase = categoryName.includes('product purchase');
        document.getElementById('productFields').classList.toggle('d-none', !isProductPurchase);
        
        // Reset product fields when switching away from product purchase
        if (!isProductPurchase) {
            selectedProducts = [];
            document.getElementById('productList').innerHTML = '';
            updateTotalAmount();
        }
    });

    // 2. Add product row
    document.getElementById('addProductBtn').addEventListener('click', () => {
        const id = productCounter++;
        const row = document.createElement('div');
        row.className = 'card mb-2 p-2';
        row.id = `product-row-${id}`;
        row.innerHTML = `
            <div class="row align-items-end">
                <div class="col-md-4">
                    <label class="form-label small">Product</label>
                    <select class="form-select form-select-sm product-select" data-id="${id}">
                        <option value="">-- Select --</option>
                        ${products.map(p => `
                            <option value="${p.id}" 
                                    data-buy-price="${p.buy_price}"
                                    data-unit="${p.unit}">
                                ${p.name} (${p.stock} ${p.unit})
                            </option>
                        `).join('')}
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label small">Quantity</label>
                    <input type="number" step="0.01" class="form-control form-control-sm quantity-input" 
                           data-id="${id}" value="1">
                </div>
                <div class="col-md-3">
                    <label class="form-label small">Buy Price</label>
                    <input type="number" step="0.01" class="form-control form-control-sm price-input" 
                           data-id="${id}">
                </div>
                <div class="col-md-2">
                    <button type="button" class="btn btn-sm btn-danger w-100 remove-btn" data-id="${id}">
                        Remove
                    </button>
                </div>
            </div>
            <div class="mt-1 small text-muted">
                Subtotal: <strong class="subtotal" data-id="${id}">Rp 0</strong>
            </div>
        `;
        
        document.getElementById('productList').appendChild(row);
        
        // Attach event listeners
        attachProductEvents(id);
    });

    function attachProductEvents(id) {
        // Product selection
        const selectEl = document.querySelector(`.product-select[data-id="${id}"]`);
        selectEl.addEventListener('change', e => {
            const option = e.target.options[e.target.selectedIndex];
            if (option.value) {
                document.querySelector(`.price-input[data-id="${id}"]`).value = option.dataset.buyPrice;
                updateProductSubtotal(id);
            }
        });

        // Quantity change
        document.querySelector(`.quantity-input[data-id="${id}"]`).addEventListener('input', () => {
            updateProductSubtotal(id);
        });

        // Price change
        document.querySelector(`.price-input[data-id="${id}"]`).addEventListener('input', () => {
            updateProductSubtotal(id);
        });

        // Remove button
        document.querySelector(`.remove-btn[data-id="${id}"]`).addEventListener('click', () => {
            document.getElementById(`product-row-${id}`).remove();
            updateTotalAmount();
        });
    }

    function updateProductSubtotal(id) {
        const qty = parseFloat(document.querySelector(`.quantity-input[data-id="${id}"]`).value) || 0;
        const price = parseFloat(document.querySelector(`.price-input[data-id="${id}"]`).value) || 0;
        const subtotal = qty * price;
        
        document.querySelector(`.subtotal[data-id="${id}"]`).textContent = 
            `Rp ${subtotal.toLocaleString('id-ID', {minimumFractionDigits: 2})}`;
        
        updateTotalAmount();
    }

    function updateTotalAmount() {
        let total = 0;
        document.querySelectorAll('.product-select').forEach(select => {
            const id = select.dataset.id;
            const qty = parseFloat(document.querySelector(`.quantity-input[data-id="${id}"]`).value) || 0;
            const price = parseFloat(document.querySelector(`.price-input[data-id="${id}"]`).value) || 0;
            total += qty * price;
        });
        
        document.getElementById('amount').value = total.toFixed(2);
    }

    // Form submission
    document.getElementById('cashflowForm').addEventListener('submit', async e => {
        e.preventDefault();

        const categorySelect = document.getElementById('category');
        const selectedOption = categorySelect.options[categorySelect.selectedIndex];
        const categoryName = selectedOption.dataset.name.toLowerCase();
        const isProductPurchase = categoryName.includes('product purchase');

        const payload = {
            category_id: categorySelect.value,
            description: document.getElementById('description').value,
            amount: document.getElementById('amount').value,
            date: document.getElementById('cashflow_date').value  // e.g. "2025-02-17T14:30"
        };

        if (isProductPurchase) {
            const products = [];
            document.querySelectorAll('.product-select').forEach(select => {
                const id = select.dataset.id;
                const productId = select.value;
                
                if (productId) {
                    products.push({
                        product_id: productId,
                        quantity: document.querySelector(`.quantity-input[data-id="${id}"]`).value,
                        buy_price: document.querySelector(`.price-input[data-id="${id}"]`).value
                    });
                }
            });
            
            if (products.length === 0) {
                alert('Please add at least one product');
                return;
            }
            
            payload.products = products;
        }

        const res = await fetch('/api/cashflow', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });

        if (res.ok) {
            alert('Cashflow saved');
            location.reload();
        } else {
            alert('Failed to save cashflow');
        }
    });

    // Trigger category change on page load
    document.getElementById('category').dispatchEvent(new Event('change'));
    </script>
{% endblock %}