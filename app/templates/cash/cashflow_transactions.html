{% extends "base.html" %}
{% block title %}Cashflow Transactions{% endblock %}
{% block page_title %}Cashflow Transactions{% endblock %}

{% block content %}
    <style>
        .table-responsive {
            border-radius: 0.5rem;
        }

        .table thead th {
            background-color: #f8f9fa;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.5px;
            padding: 1rem 0.75rem;
            border-bottom: 2px solid #dee2e6;
        }

        .table tbody tr {
            transition: background-color 0.15s ease;
        }

        .table tbody tr:hover {
            background-color: #f8f9fa;
        }

        /* Details/Summary enhancements */
        details {
            cursor: pointer;
            padding: 0.25rem 0;
        }

        details summary {
            font-weight: 500;
            color: #0d6efd;
            transition: color 0.15s ease;
            user-select: none;
        }

        details summary:hover {
            color: #0a58ca;
            text-decoration: underline;
        }

        details[open] summary {
            margin-bottom: 0.5rem;
        }

        details ul {
            padding-left: 1.25rem;
            margin-top: 0.5rem;
        }

        details ul li {
            padding: 0.25rem 0;
            font-size: 0.875rem;
        }

        /* Badge enhancements */
        .badge {
            font-weight: 500;
            padding: 0.375rem 0.75rem;
            font-size: 0.75rem;
        }

        /* Amount styling */
        .text-success {
            color: #198754 !important;
        }

        .text-danger {
            color: #dc3545 !important;
        }

        /* Loading spinner */
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }

        /* Empty state */
        #emptyState svg {
            opacity: 0.5;
        }

        /* Pagination */
        .pagination {
            margin-bottom: 0;
        }

        .pagination .page-link {
            color: #495057;
            border-color: #dee2e6;
            transition: all 0.15s ease;
        }

        .pagination .page-link:hover {
            background-color: #e9ecef;
            border-color: #dee2e6;
        }

        .pagination .page-item.active .page-link {
            background-color: #0d6efd;
            border-color: #0d6efd;
        }

        .pagination .page-item.disabled .page-link {
            color: #6c757d;
            background-color: #fff;
            border-color: #dee2e6;
        }

        /* Filter section */
        .form-label {
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: #495057;
        }

        .form-control,
        .form-select {
            border: 1px solid #ced4da;
            transition: border-color 0.15s ease, box-shadow 0.15s ease;
        }

        .form-control:focus,
        .form-select:focus {
            border-color: #86b7fe;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }

        /* Card enhancements */
        .card {
            border: 1px solid rgba(0, 0, 0, 0.08);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.04);
        }

        .card-body {
            padding: 1.5rem;
        }

        /* Alert enhancements */
        .alert {
            border-radius: 0.5rem;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .table {
                font-size: 0.875rem;
            }
            
            .card-body {
                padding: 1rem;
            }
            
            details summary {
                font-size: 0.875rem;
            }
            
            .badge {
                font-size: 0.625rem;
                padding: 0.25rem 0.5rem;
            }
        }

        /* Smooth transitions */
        * {
            transition-property: background-color, border-color, color;
            transition-duration: 0.15s;
            transition-timing-function: ease;
        }

        /* Reference details styling */
        .small {
            font-size: 0.875rem;
            line-height: 1.5;
        }

        .small strong {
            display: block;
            margin-bottom: 0.25rem;
            color: #212529;
        }

        /* Item details in reference */
        .small div {
            color: #6c757d;
        }

        .small div strong {
            display: inline;
            color: #212529;
        }

        /* Info badge for delivery */
        .badge.bg-info {
            background-color: #0dcaf0 !important;
        }

        /* Date input styling */
        input[type="date"] {
            position: relative;
        }

        input[type="date"]::-webkit-calendar-picker-indicator {
            cursor: pointer;
            opacity: 0.6;
            transition: opacity 0.15s ease;
        }

        input[type="date"]::-webkit-calendar-picker-indicator:hover {
            opacity: 1;
        }

        /* Total count styling */
        #totalCount {
            font-size: 0.875rem;
            font-weight: 500;
        }

        /* Loading state overlay */
        #loadingIndicator {
            min-height: 400px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        /* Error message styling */
        #errorMessage {
            margin: 2rem 0;
        }

        /* Table cell padding adjustments */
        .table td {
            vertical-align: middle;
            padding: 0.75rem;
        }

        .table th {
            vertical-align: middle;
        }

        /* Transaction type indicators */
        .transaction-income {
            border-left: 3px solid #198754;
        }

        .transaction-expense {
            border-left: 3px solid #dc3545;
        }
    </style>

    <div class="row mb-3">
        <div class="col-md-3">
            <label class="form-label">Filter by Date</label>
            <input type="date" id="dateFilter" class="form-control" value="">
        </div>
        <div class="col-md-3">
            <label class="form-label">Filter by Category</label>
            <select id="categoryFilter" class="form-select">
                <option value="all">All Categories</option>
                <option value="Product Sales">Product Sales</option>
                <option value="Delivery Fees">Delivery Fees</option>
                <option value="Product Purchases">Product Purchases</option>
                <option value="Salaries & Wages">Salaries & Wages</option>
                {% for cat in categories %}
                    {% if cat.name not in ['Product Sales', 'Delivery Fees', 'Product Purchases', 'Salaries & Wages'] %}
                    <option value="{{ cat.name }}">{{ cat.name }}</option>
                    {% endif %}
                {% endfor %}
            </select>
        </div>
        <div class="col-md-6 text-end">
            <p class="text-muted mt-4">
                <span id="totalCount">Loading...</span>
            </p>
        </div>
    </div>

    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body">
                    <!-- Loading indicator -->
                    <div id="loadingIndicator" class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2 text-muted">Loading transactions...</p>
                    </div>

                    <!-- Error message -->
                    <div id="errorMessage" class="alert alert-danger d-none" role="alert">
                        <strong>Error:</strong> <span id="errorText"></span>
                    </div>

                    <!-- Transactions table -->
                    <div id="transactionsTable" class="table-responsive d-none">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Date & Time</th>
                                    <th>Category</th>
                                    <th>Description</th>
                                    <th>Reference</th>
                                    <th class="text-end">Amount</th>
                                </tr>
                            </thead>
                            <tbody id="transactionsBody">
                                <!-- Populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Empty state -->
                    <div id="emptyState" class="text-center py-5 d-none">
                        <svg width="64" height="64" class="mb-3 text-muted" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                            <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
                        </svg>
                        <p class="text-muted">No transactions found for the selected filters.</p>
                    </div>

                    <!-- Pagination -->
                    <nav id="paginationNav" aria-label="Page navigation" class="mt-3 d-none">
                        <ul class="pagination justify-content-center" id="paginationContainer">
                            <!-- Populated by JavaScript -->
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
    <script>
        // State management
        let currentPage = 1;
        let currentDate = new Date().toISOString().split('T')[0];
        let currentCategory = 'all';

        // Set initial date value
        document.getElementById('dateFilter').value = currentDate;

        // Utility: Format currency
        function formatCurrency(amount) {
            return 'Rp ' + parseFloat(amount).toLocaleString('id-ID', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            });
        }

        // Utility: Format datetime
        function formatDateTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('id-ID', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Render transaction reference details
        function renderReference(transaction) {
            if (transaction.category === 'Product Purchases' && transaction.items.length > 0) {
                return `
                    <div class="small">
                        <strong>Product Purchase</strong>
                        <details>
                            <summary>${transaction.items.length} item(s)</summary>
                            <div class="mt-1">
                                ${transaction.items.map(item => `
                                    <div class="mt-1">
                                        • ${item.name}: 
                                        ${item.quantity} ${item.unit} × ${formatCurrency(item.price)} = 
                                        <strong>${formatCurrency(item.subtotal)}</strong>
                                    </div>
                                `).join('')}
                            </div>
                        </details>
                    </div>
                `;
            } else if (transaction.type === 'order' && transaction.items.length > 0) {
                return `
                    <div class="small">
                        <strong>Order #${transaction.reference_id}</strong><br>
                        Customer: ${transaction.customer_name || 'N/A'}
                        <br>
                        <details>
                            <summary>${transaction.items.length} item(s)</summary>
                            <ul class="mb-0 mt-1">
                                ${transaction.items.map(item => `
                                    <li>
                                        ${item.name}: 
                                        ${item.quantity} × ${formatCurrency(item.sell_price)} 
                                        = ${formatCurrency(item.subtotal)}
                                    </li>
                                `).join('')}
                            </ul>
                        </details>
                    </div>
                `;
            } else if (transaction.type === 'delivery_order') {
                return `
                    <div class="small">
                        <strong>Order #${transaction.reference_id}</strong><br>
                        <span class="badge bg-info">Delivery Fee</span>
                    </div>
                `;
            } else {
                return '<span class="text-muted">General</span>';
            }
        }

        // Render transactions
        function renderTransactions(data) {
            const tbody = document.getElementById('transactionsBody');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const errorMessage = document.getElementById('errorMessage');
            const transactionsTable = document.getElementById('transactionsTable');
            const emptyState = document.getElementById('emptyState');
            const paginationNav = document.getElementById('paginationNav');
            const totalCount = document.getElementById('totalCount');

            // Hide loading
            loadingIndicator.classList.add('d-none');
            errorMessage.classList.add('d-none');

            if (!data.success) {
                errorMessage.classList.remove('d-none');
                document.getElementById('errorText').textContent = data.error || 'Unknown error occurred';
                transactionsTable.classList.add('d-none');
                emptyState.classList.add('d-none');
                paginationNav.classList.add('d-none');
                return;
            }

            const transactions = data.transactions || [];
            const pagination = data.pagination || {};

            // Update total count
            totalCount.textContent = `Total: ${pagination.total_count || 0} transaction(s) on ${data.filters.date}`;

            if (transactions.length === 0) {
                emptyState.classList.remove('d-none');
                transactionsTable.classList.add('d-none');
                paginationNav.classList.add('d-none');
                return;
            }

            // Show table
            emptyState.classList.add('d-none');
            transactionsTable.classList.remove('d-none');

            // Populate table
            tbody.innerHTML = transactions.map(trx => {
                const isIncome = trx.category_type === 'income';
                const badgeClass = isIncome ? 'success' : 'danger';
                const amountClass = isIncome ? 'success' : 'danger';
                const amountPrefix = isIncome ? '+' : '-';

                return `
                    <tr>
                        <td>${formatDateTime(trx.date)}</td>
                        <td>
                            <span class="badge bg-${badgeClass}">
                                ${trx.category}
                            </span>
                        </td>
                        <td>${trx.description || '-'}</td>
                        <td>${renderReference(trx)}</td>
                        <td class="text-end">
                            <strong class="text-${amountClass}">
                                ${amountPrefix} ${formatCurrency(trx.amount)}
                            </strong>
                        </td>
                    </tr>
                `;
            }).join('');

            // Render pagination
            if (pagination.total_pages > 1) {
                renderPagination(pagination);
                paginationNav.classList.remove('d-none');
            } else {
                paginationNav.classList.add('d-none');
            }
        }

        // Render pagination
        function renderPagination(pagination) {
            const container = document.getElementById('paginationContainer');
            const { page, total_pages } = pagination;
            
            let html = '';

            // Previous button
            html += `
                <li class="page-item ${page === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" data-page="${page - 1}">Previous</a>
                </li>
            `;

            // Page numbers
            for (let p = 1; p <= total_pages; p++) {
                if (p === 1 || p === total_pages || (p >= page - 2 && p <= page + 2)) {
                    html += `
                        <li class="page-item ${p === page ? 'active' : ''}">
                            <a class="page-link" href="#" data-page="${p}">${p}</a>
                        </li>
                    `;
                } else if (p === page - 3 || p === page + 3) {
                    html += `
                        <li class="page-item disabled">
                            <span class="page-link">...</span>
                        </li>
                    `;
                }
            }

            // Next button
            html += `
                <li class="page-item ${page === total_pages ? 'disabled' : ''}">
                    <a class="page-link" href="#" data-page="${page + 1}">Next</a>
                </li>
            `;

            container.innerHTML = html;

            // Add click handlers
            container.querySelectorAll('a.page-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const pageNum = parseInt(this.dataset.page);
                    if (pageNum > 0 && pageNum <= total_pages) {
                        currentPage = pageNum;
                        loadTransactions();
                    }
                });
            });
        }

        // Load transactions from API
        function loadTransactions() {
            const loadingIndicator = document.getElementById('loadingIndicator');
            const transactionsTable = document.getElementById('transactionsTable');
            const emptyState = document.getElementById('emptyState');
            const errorMessage = document.getElementById('errorMessage');
            const paginationNav = document.getElementById('paginationNav');

            // Show loading
            loadingIndicator.classList.remove('d-none');
            transactionsTable.classList.add('d-none');
            emptyState.classList.add('d-none');
            errorMessage.classList.add('d-none');
            paginationNav.classList.add('d-none');

            const params = new URLSearchParams({
                date: currentDate,
                category: currentCategory,
                page: currentPage
            });

            fetch(`/api/cashflow/transactions?${params}`)
                .then(response => response.json())
                .then(data => renderTransactions(data))
                .catch(error => {
                    loadingIndicator.classList.add('d-none');
                    errorMessage.classList.remove('d-none');
                    document.getElementById('errorText').textContent = error.message;
                });
        }

        // Event listeners
        document.getElementById('dateFilter').addEventListener('change', function() {
            currentDate = this.value;
            currentPage = 1;
            loadTransactions();
        });

        document.getElementById('categoryFilter').addEventListener('change', function() {
            currentCategory = this.value;
            currentPage = 1;
            loadTransactions();
        });

        loadTransactions();
    </script>
{% endblock %}
