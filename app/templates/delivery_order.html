{% extends "base.html" %}

{% block title %}Delivery Orders{% endblock %}
{% block page_title %}Delivery Orders{% endblock %}

    <script src="https://unpkg.com/leaflet@1.9.4/dist/js/leaflet.js"></script>

{% block content %}
    <style>
            :root {
                --page-offset: 160px; /* header + paddings */
            }

            .vh-fit {
                height: calc(100vh - var(--page-offset));
            }

            .order-scroll {
                overflow-y: auto;
            }

            #map {
                height: 100%;
                min-height: 300px;
            }

        .customer-label {
            background: white;
            border: 1px solid #0d6efd;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            color: #0d6efd;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
    </style>

    <div class="row g-3">
        <div class="col-md-4">
            <div class="card p-3 mb-3">
                <label class="form-label fw-bold mb-2">Delivery Date</label>
                <input type="date" id="routeDate" class="form-control">
            </div>

            <div class="card" style="max-height: calc(100vh - 220px); overflow-y: auto;">
                <div class="card-body p-2">
                    <div id="orderList">
                    <div class="text-center py-4">
                        <div class="spinner-small d-inline-block"></div>
                        <p class="text-muted mt-2 mb-0">Loading orders...</p>
                    </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-8">
            <div class="card">
            <div class="card-body p-0 position-relative">
                <div class="position-absolute top-0 end-0 m-3" style="z-index: 1000;">
                <button class="btn btn-primary btn-sm shadow" onclick="fitMapBounds()">
                    <i class="bi bi-fullscreen"></i> Fit All
                </button>
                </div>

                <div id="map" style="height: calc(100vh - 180px); border-radius: 0.375rem;"></div>
            </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        const depot = { lat: -7.586659740785085, lng: 110.94502385669738 };
        const map = L.map('map').setView([depot.lat, depot.lng], 13);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        const depotIcon = L.icon({
            iconUrl: 'https://cdn-icons-png.flaticon.com/512/69/69524.png',
            iconSize: [32, 32],
            iconAnchor: [16, 32],
            popupAnchor: [0, -32]
        });

        let markers = [];
        let bounds = L.latLngBounds([[depot.lat, depot.lng]]);

        async function loadOrders() {
            const date = document.getElementById('routeDate').value;

            const depotMarker = L.marker([depot.lat, depot.lng], { icon: depotIcon })
                .addTo(map)
                .bindPopup('<b>Depot</b>');

            const res = await fetch(`/api/delivery-orders?date=${date}`);
            const data = await res.json();

            if (!Array.isArray(data)) {
                document.getElementById('orderList').innerHTML =
                `<div class="alert alert-danger">${data.error}</div>`;
                return;
            }

            renderOrders(data);
            renderMarkers(data);
        }

        function statusBadge(status) {
            switch (status) {
                case 'cancelled': return 'bg-danger';
                case 'delivered': return 'bg-success';
                case 'paid': return 'bg-warning text-dark';
                default: return 'bg-primary';
            }
        }

        function statusBorder(status) {
            switch (status) {
                case 'cancelled': return 'border-danger';
                case 'delivered': return 'border-success';
                case 'paid': return 'border-warning';
                default: return 'border-primary';
            }
        }

        function renderOrders(orders) {
            const el = document.getElementById('orderList');

            if (!orders.length) {
                el.innerHTML = `<p class="text-muted text-center">No delivery orders</p>`;
                return;
            }

            el.innerHTML = orders.map((o, i) => {
                const items = o.products.map(p =>
                    `<li>${p.name} (${p.quantity} ${p.unit})</li>`
                ).join('');

                const grandTotal = o.total_amount + o.delivery_price;

                return `
                <div class="card mb-2 border-start border-4 ${statusBorder(o.status)}"
                    onclick="focusOrder(${o.latitude}, ${o.longitude})">
                    <div class="card-body p-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <b>${i + 1}. ${o.customer_name}</b>
                            <span class="badge ${statusBadge(o.status)}">${o.status}</span>
                        </div>

                        <small class="text-muted">Order #${o.order_id}</small>

                        <ul class="mt-2 mb-1 ps-3 small">
                            ${items}
                        </ul>

                        <div class="small">
                            Delivery: <b>${o.delivery_price.toLocaleString()}</b><br>
                            Total: <b>${grandTotal.toLocaleString()}</b>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
        }

        function renderMarkers(orders) {
            markers.forEach(m => map.removeLayer(m));
            markers = [];

            bounds = L.latLngBounds([[depot.lat, depot.lng]]);

            orders.forEach((o, i) => {
                const m = L.marker([o.latitude, o.longitude])
                    .addTo(map)
                    .bindPopup(`
                        <b>${o.customer_name}</b><br>
                        Order #${o.order_id}<br>
                    `);

                markers.push(m);
                bounds.extend([o.latitude, o.longitude]);
            });

            // include depot marker in bounds
            bounds.extend([depot.lat, depot.lng]);

            map.fitBounds(bounds, { padding: [40, 40] });
        }

        function focusOrder(lat, lng) {
            map.setView([lat, lng], 16);
        }

        document.addEventListener("DOMContentLoaded", () => {
            document.getElementById("routeDate").value =
                new Date().toISOString().split("T")[0];
            loadOrders();
            document.getElementById("routeDate").addEventListener("change", loadOrders);
        });
    </script>
{% endblock %}
