{% extends "base.html" %}
{% block title %}Add Cashflow{% endblock %}
{% block page_title %}Add Cashflow{% endblock %}

{% block content %}
    <div class="row">
        <div class="col-md-12">
            <div class="card p-3">
                <form id="cashflowForm">
                    <label class="form-label">Category</label>
                    <select id="category" class="form-select" required>
                        {% for c in categories %}
                            <option value="{{ c.id }}" data-name="{{ c.name }}">{{ c.name }}</option>
                        {% endfor %}
                    </select>

                    <label class="form-label mt-2">Description</label>
                    <input class="form-control" id="description">

                    <hr>

                    <div id="productFields" class="d-none">
                        <label class="form-label">Product</label>
                        <select id="product" class="form-select">
                            <option value="">-- Select Product --</option>
                            {% for p in products %}
                            <option value="{{ p.id }}" 
                                    data-buy-price="{{ p.buy_price }}"
                                    data-unit="{{ p.unit }}">
                                {{ p.name }} (stock: {{ p.stock }} {{ p.unit }})
                            </option>
                            {% endfor %}
                        </select>

                        <label class="form-label mt-2">Quantity</label>
                        <input type="number" step="0.01" id="quantity" class="form-control">

                        <label class="form-label mt-2">Buy Price / unit</label>
                        <input type="number" step="0.01" id="buy_price" class="form-control">
                    </div>

                    <label class="form-label mt-2">Total Amount</label>
                    <input type="number" step="0.01" id="amount" class="form-control" required>

                    <button class="btn btn-primary mt-3 w-100">Save</button>
                </form>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
    <script>
    // 1. Show/hide product fields based on category name
    document.getElementById('category').addEventListener('change', e => {
        const selectedOption = e.target.options[e.target.selectedIndex];
        const categoryName = selectedOption.dataset.name.toLowerCase();
        
        const isProductPurchase = categoryName.includes('product purchase');
        document.getElementById('productFields').classList.toggle('d-none', !isProductPurchase);
        
        // Reset product fields when switching away from product purchase
        if (!isProductPurchase) {
            document.getElementById('product').value = '';
            document.getElementById('quantity').value = '';
            document.getElementById('buy_price').value = '';
        }
    });

    // 2. Auto-fill quantity and buy price when product is selected
    document.getElementById('product').addEventListener('change', e => {
        const selectedOption = e.target.options[e.target.selectedIndex];
        
        if (selectedOption.value) {
            const buyPrice = selectedOption.dataset.buyPrice;
            
            // Set quantity to 1
            document.getElementById('quantity').value = 1;
            
            // Set buy price from product data
            document.getElementById('buy_price').value = buyPrice;
            
            // Calculate total amount
            updateTotalAmount();
        } else {
            document.getElementById('quantity').value = '';
            document.getElementById('buy_price').value = '';
            document.getElementById('amount').value = '';
        }
    });

    // 3. Auto-calculate total amount when quantity or buy price changes
    function updateTotalAmount() {
        const quantity = parseFloat(document.getElementById('quantity').value) || 0;
        const buyPrice = parseFloat(document.getElementById('buy_price').value) || 0;
        const total = quantity * buyPrice;
        
        document.getElementById('amount').value = total.toFixed(2);
    }

    document.getElementById('quantity').addEventListener('input', updateTotalAmount);
    document.getElementById('buy_price').addEventListener('input', updateTotalAmount);

    // Form submission
    document.getElementById('cashflowForm').addEventListener('submit', async e => {
        e.preventDefault();

        const categorySelect = document.getElementById('category');
        const selectedOption = categorySelect.options[categorySelect.selectedIndex];
        const categoryName = selectedOption.dataset.name.toLowerCase();
        const isProductPurchase = categoryName.includes('product purchase');

        const payload = {
            category_id: categorySelect.value,
            description: document.getElementById('description').value,
            amount: document.getElementById('amount').value
        };

        if (isProductPurchase) {
            payload.product_id = document.getElementById('product').value;
            payload.quantity = document.getElementById('quantity').value;
            payload.buy_price = document.getElementById('buy_price').value;
        }

        const res = await fetch('/api/cashflow', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });

        if (res.ok) {
            alert('Cashflow saved');
            location.reload();
        }
    });

    // Trigger category change on page load to show/hide fields if needed
    document.getElementById('category').dispatchEvent(new Event('change'));
    </script>
{% endblock %}