{% extends "base.html" %}

{% block title %}Orders{% endblock %}
{% block page_title %}Orders{% endblock %}

{% block content %}
<!-- Filters -->
<div class="card p-3 mb-4">
  <div class="row g-3">
    <div class="col-md-4">
      <input type="text" id="searchInput" class="form-control" placeholder="Search customer name...">
    </div>
    <div class="col-md-3">
      <select id="statusFilter" class="form-select">
        <option value="all">All Status</option>
        <option value="pending">Pending</option>
        <option value="paid">Paid</option>
        <option value="delivered">Delivered</option>
        <option value="cancelled">Cancelled</option>
      </select>
    </div>
    <div class="col-md-2">
      <button class="btn btn-primary w-100" onclick="loadOrders()">
        <i class="bi bi-search"></i> Search
      </button>
    </div>
  </div>
</div>

<!-- Loading skeleton -->
<div id="ordersLoading">
  <div class="card mb-3 p-3">
    <div class="skeleton skeleton-lg mb-2"></div>
    <div class="skeleton"></div>
  </div>
  <div class="card mb-3 p-3">
    <div class="skeleton skeleton-lg mb-2"></div>
    <div class="skeleton"></div>
  </div>
  <div class="card mb-3 p-3">
    <div class="skeleton skeleton-lg mb-2"></div>
    <div class="skeleton"></div>
  </div>
</div>

<!-- Orders list -->
<div id="ordersList" class="hidden"></div>

<!-- Empty state -->
<div id="emptyState" class="hidden text-center py-5">
  <i class="bi bi-inbox" style="font-size: 3rem; color: #ccc;"></i>
  <p class="text-muted mt-3">No orders found</p>
</div>
{% endblock %}

{% block extra_js %}
<script>
function formatRupiah(amount) {
  return new Intl.NumberFormat('id-ID').format(amount);
}

function formatDate(dateString) {
  const date = new Date(dateString);
  return date.toLocaleDateString('id-ID', { 
    year: 'numeric', 
    month: 'long', 
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  });
}

function getStatusBadge(status) {
  const badges = {
    'pending': 'bg-warning',
    'paid': 'bg-info',
    'delivered': 'bg-success',
    'cancelled': 'bg-danger'
  };
  return badges[status] || 'bg-secondary';
}

function getStatusText(status) {
  const texts = {
    'pending': 'Pending',
    'paid': 'Paid',
    'delivered': 'Delivered',
    'cancelled': 'Cancelled'
  };
  return texts[status] || status;
}

async function updateOrderStatus(orderId, newStatus, cardElement) {
  const dropdown = cardElement.querySelector('select');
  const originalStatus = dropdown.value;
  
  try {
    dropdown.disabled = true;
    
    const response = await fetch(`/api/orders/${orderId}/status`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ status: newStatus })
    });
    
    if (!response.ok) throw new Error('Failed to update status');
    
    // Update badge
    const badge = cardElement.querySelector('.badge');
    badge.className = `badge ${getStatusBadge(newStatus)}`;
    badge.textContent = getStatusText(newStatus);
    
    // Show success message
    showToast('Status updated successfully', 'success');
    
  } catch (error) {
    console.error('Error updating status:', error);
    dropdown.value = originalStatus; // Revert dropdown
    showToast('Failed to update status', 'error');
  } finally {
    dropdown.disabled = false;
  }
}

function showToast(message, type) {
  // Simple toast notification (you can replace with better library)
  const toast = document.createElement('div');
  toast.className = `alert alert-${type === 'success' ? 'success' : 'danger'} position-fixed top-0 end-0 m-3`;
  toast.style.zIndex = '9999';
  toast.textContent = message;
  document.body.appendChild(toast);
  
  setTimeout(() => toast.remove(), 3000);
}

async function loadOrders() {
  const loadingEl = document.getElementById('ordersLoading');
  const listEl = document.getElementById('ordersList');
  const emptyEl = document.getElementById('emptyState');
  
  try {
    loadingEl.classList.remove('hidden');
    listEl.classList.add('hidden');
    emptyEl.classList.add('hidden');
    
    const status = document.getElementById('statusFilter').value;
    const search = document.getElementById('searchInput').value;
    
    const params = new URLSearchParams();
    if (status !== 'all') params.append('status', status);
    if (search) params.append('search', search);
    
    const response = await fetch(`/api/orders?${params}`);
    const orders = await response.json();
    
    loadingEl.classList.add('hidden');
    
    if (orders.length === 0) {
      emptyEl.classList.remove('hidden');
      return;
    }
    
    listEl.innerHTML = orders.map(order => `
      <div class="card mb-3" id="order-${order.id}">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <div>
              <h5 class="card-title mb-1">
                <i class="bi bi-receipt"></i> Order #${order.id}
              </h5>
              <small class="text-muted">${formatDate(order.order_date)}</small>
            </div>
            <span class="badge ${getStatusBadge(order.status)}">
              ${getStatusText(order.status)}
            </span>
          </div>
          
          <div class="mb-3">
            <p class="mb-1">
              <i class="bi bi-person"></i> 
              <strong>${order.customers.name}</strong>
            </p>
            ${order.customers.phone ? `
              <p class="mb-1 text-muted">
                <i class="bi bi-telephone"></i> ${order.customers.phone}
              </p>
            ` : ''}
            ${order.customers.address ? `
              <p class="mb-1 text-muted">
                <i class="bi bi-geo-alt"></i> ${order.customers.address}
              </p>
            ` : ''}
          </div>
          
          <!-- PRODUCTS LIST -->
          <div class="mb-3">
            <small class="text-muted d-block mb-2"><strong>Products:</strong></small>
            <div class="border rounded p-2 bg-light">
              ${order.order_items.map(item => `
                <div class="d-flex justify-content-between align-items-center mb-1">
                  <span>
                    ${item.products.name}
                    <small class="text-muted">(${item.quantity} ${item.products.unit})</small>
                  </span>
                  <span class="text-end">
                    <small>Rp ${formatRupiah(item.sell_price)} Ã— ${item.quantity}</small>
                    <br>
                    <strong>Rp ${formatRupiah(item.sell_price * item.quantity)}</strong>
                  </span>
                </div>
              `).join('')}
            </div>
          </div>
          
          <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
              <strong>Total: Rp ${formatRupiah(order.total_amount)}</strong>
              ${order.delivery_price > 0 ? `
                <small class="text-muted d-block">
                  + Delivery: Rp ${formatRupiah(order.delivery_price)}
                </small>
              ` : ''}
            </div>
            <span class="badge bg-secondary">
              ${order.delivery_type === 'delivery' ? 
                '<i class="bi bi-truck"></i> Delivery' : 
                '<i class="bi bi-bag"></i> Pickup'}
            </span>
          </div>
          
          <div class="border-top pt-3">
            <label class="form-label mb-2">
              <small class="text-muted">Update Status:</small>
            </label>
            <select class="form-select form-select-sm" 
                    onchange="updateOrderStatus(${order.id}, this.value, this.closest('.card'))"
                    ${order.status === 'cancelled' || order.status === 'delivered' ? 'disabled' : ''}>
              <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>Pending</option>
              <option value="paid" ${order.status === 'paid' ? 'selected' : ''}>Paid</option>
              <option value="delivered" ${order.status === 'delivered' ? 'selected' : ''}>Delivered</option>
              <option value="cancelled" ${order.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
            </select>
          </div>
        </div>
      </div>
    `).join('');
    
    listEl.classList.remove('hidden');
    
  } catch (error) {
    console.error('Error loading orders:', error);
    loadingEl.classList.add('hidden');
    showToast('Failed to load orders', 'error');
  }
}

// Load orders on page load
document.addEventListener('DOMContentLoaded', loadOrders);

// Enter key on search
document.getElementById('searchInput').addEventListener('keypress', (e) => {
  if (e.key === 'Enter') loadOrders();
});
</script>
{% endblock %}