{% extends "base.html" %}

{% block title %}Customers{% endblock %}
{% block page_title %}Customers{% endblock %}

{% block content %}
    <div class="row g-3">
        <div class="col-lg-4 col-md-5">
            <div class="card customer-list-container">
                <div class="customer-list-header">
                    <a href="{{ url_for('web.customer.add_customer_page') }}" class="btn btn-primary w-100 mb-3">
                        <i class="bi bi-plus-circle"></i> Add Customer
                    </a>
                    
                    <div class="search-box">
                        <i class="bi bi-search search-icon"></i>
                        <input 
                            type="text" 
                            class="form-control" 
                            id="searchInput" 
                            placeholder="Search customers..."
                            onkeyup="searchCustomers()">
                    </div>
                </div>

                <div class="customer-list-body" id="customerList">
                    <div class="text-center py-4">
                        <div class="spinner-border spinner-border-sm"></div>
                        <p class="text-muted mt-2 mb-0">Loading customers...</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-8 col-md-7">
            <div class="card">
                <div class="card-body p-0 position-relative">
                    <div class="position-absolute top-0 end-0 m-3" style="z-index: 1000;">
                        <button class="btn btn-primary btn-sm shadow" onclick="fitMapBounds()">
                            <i class="bi bi-fullscreen"></i> Fit All
                        </button>
                    </div>
                    <div id="map" class="rounded"></div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        const depot = {
            lat: -7.586659740785085,
            lng: 110.94502385669738,
            name: 'Main Depot'
        };

        const map = L.map('map').setView([depot.lat, depot.lng], 13);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        var depotIcon = L.icon({
            iconUrl:  "{{ url_for('static', filename='icons/stockroom.png') }}",
            iconSize: [32, 32],
            iconAnchor: [16, 32],
            popupAnchor: [0, -32]
        });

        var customerIcon = L.icon({
            iconUrl:  "{{ url_for('static', filename='icons/placeholder.png') }}",
            iconSize: [32, 32],
            iconAnchor: [16, 32],
            popupAnchor: [0, -32]
        });

        var depotMarker = L.marker([depot.lat, depot.lng], {icon: depotIcon})
            .addTo(map)
            .bindPopup(`
                <div class="popup-title">${depot.name}</div>
                <div class="popup-info">
                    <strong>Starting Point</strong><br>
                    üìç ${depot.lat.toFixed(6)}, ${depot.lng.toFixed(6)}
                </div>
            `);

        let markers = [];
        let bounds = L.latLngBounds([[depot.lat, depot.lng]]);
        let allCustomers = [];

        async function loadCustomers() {
            const res = await fetch('/api/customers');
            const data = await res.json();

            if (!Array.isArray(data)) {
                document.getElementById('customerList').innerHTML =
                    `<div class="alert alert-danger">${data.error}</div>`;
                return;
            }

            allCustomers = data;
            renderCustomers(data);
            renderMarkers(data);
        }

        function renderCustomers(customers) {
            const el = document.getElementById('customerList');

            if (!customers.length) {
                el.innerHTML = `<p class="text-muted text-center py-4">No customers found</p>`;
                return;
            }

            el.innerHTML = customers.map((c, i) => {
                const hasLocation = c.latitude !== null && c.longitude !== null;

                return `
                <div class="card mb-2 customer-card ${hasLocation ? '' : 'border-warning'}">
                    <div class="card-body p-2">
                        <div class="d-flex justify-content-between align-items-start mb-1">
                            <b onclick="focusCustomer(${c.latitude}, ${c.longitude})" 
                               style="cursor: pointer; flex: 1;">
                                ${i + 1}. ${c.name}
                            </b>
                            
                            <div class="customer-actions">
                                <a href="/customer/edit/${c.id}" 
                                   class="btn btn-sm btn-outline-primary"
                                   onclick="event.stopPropagation()">
                                    <i class="bi bi-pencil"></i>
                                </a>
                                ${!hasLocation
                                    ? `<span class="badge bg-warning text-dark ms-1">No Location</span>`
                                    : ''}
                            </div>
                        </div>

                        <div onclick="focusCustomer(${c.latitude}, ${c.longitude})" style="cursor: pointer;">
                            <small class="text-muted">${c.phone || 'N/A'}</small><br>
                            <small>${c.address || ''}</small>

                            ${!hasLocation
                                ? `<div class="text-danger small mt-1">
                                    <i class="bi bi-geo-alt"></i>
                                    Latitude / Longitude missing
                                </div>`
                                : ''}
                        </div>
                    </div>
                </div>
                `;
            }).join('');
        }

        function renderMarkers(customers) {
            markers.forEach(m => map.removeLayer(m));
            markers = [];

            bounds = L.latLngBounds([[depot.lat, depot.lng]]);

            customers.forEach(c => {
                if (c.latitude === null || c.longitude === null) {
                    return;
                }

                const m = L.marker([c.latitude, c.longitude], {icon: customerIcon})
                    .addTo(map)
                    .bindPopup(`
                        <b>${c.name}</b><br>
                        ${c.phone || ''}<br>
                        ${c.address || ''}<br>
                        
                    `);

                markers.push(m);
                bounds.extend([c.latitude, c.longitude]);
            });

            if (markers.length) {
                bounds.extend([depot.lat, depot.lng]);
                map.fitBounds(bounds, { padding: [40, 40] });
            }
        }

        function focusCustomer(lat, lng) {
            if (lat && lng) {
                map.setView([lat, lng], 16);
            }
        }

        function fitMapBounds() {
            if (markers.length) {
                map.fitBounds(bounds, { padding: [40, 40] });
            }
        }

        function searchCustomers() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            if (!searchTerm) {
                renderCustomers(allCustomers);
                return;
            }

            const filtered = allCustomers.filter(c => 
                c.name.toLowerCase().includes(searchTerm) ||
                (c.phone && c.phone.toLowerCase().includes(searchTerm)) ||
                (c.address && c.address.toLowerCase().includes(searchTerm))
            );

            renderCustomers(filtered);
        }

        document.addEventListener('DOMContentLoaded', loadCustomers);
    </script>
{% endblock %}
