{% extends "base.html" %}

{% block title %}Order #{{ order.id }}{% endblock %}
{% block page_title %}Order Details{% endblock %}

{% block content %}
    <div class="container-fluid py-4">
        <div class="row">
            <div class="col-lg-10 mx-auto">
                <!-- Header -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h3 class="mb-0">Order #{{ order.id }}</h3>
                        <small class="text-muted">
                            Created on {{ order.order_date.strftime('%B %d, %Y at %H:%M') }}
                        </small>
                    </div>
                    <div>
                        <a href="{{ url_for('orders_list') }}" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left"></i> Back to Orders
                        </a>
                    </div>
                </div>

                <div class="row">
                    <!-- Left Column: Order Info -->
                    <div class="col-md-8">
                        <!-- Customer Information -->
                        <div class="card shadow-sm mb-4">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0"><i class="bi bi-person-circle"></i> Customer Information</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <p class="mb-2">
                                            <strong>Name:</strong><br>
                                            {{ order.customer_name }}
                                        </p>
                                        <p class="mb-2">
                                            <strong>Phone:</strong><br>
                                            {{ order.customer_phone or 'N/A' }}
                                        </p>
                                    </div>
                                    <div class="col-md-6">
                                        <p class="mb-2">
                                            <strong>Address:</strong><br>
                                            {{ order.customer_address or 'N/A' }}
                                        </p>
                                        <p class="mb-2">
                                            <strong>Created By:</strong><br>
                                            {{ order.created_by_name or 'N/A' }}
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Order Items -->
                        <div class="card shadow-sm mb-4">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0"><i class="bi bi-cart3"></i> Order Items</h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Product</th>
                                                <th class="text-center">Quantity</th>
                                                <th class="text-end">Buy Price</th>
                                                <th class="text-end">Sell Price</th>
                                                <th class="text-end">Subtotal</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for item in order.order_items %}
                                            <tr>
                                                <td>{{ item.product_name }}</td>
                                                <td class="text-center">
                                                    {{ item.quantity }} {{ item.product_unit }}
                                                </td>
                                                <td class="text-end">{{ item.buy_price|currency }}</td>
                                                <td class="text-end">{{ item.sell_price|currency }}</td>
                                                <td class="text-end fw-bold">{{ item.subtotal|currency }}</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                        <tfoot>
                                            <tr>
                                                <td colspan="4" class="text-end"><strong>Items Total:</strong></td>
                                                <td class="text-end fw-bold">
                                                    {{ (order.total_amount - order.delivery_price)|currency }}
                                                </td>
                                            </tr>
                                            {% if order.delivery_price > 0 %}
                                            <tr>
                                                <td colspan="4" class="text-end"><strong>Delivery Fee:</strong></td>
                                                <td class="text-end fw-bold">{{ order.delivery_price|currency }}</td>
                                            </tr>
                                            {% endif %}
                                            <tr class="table-primary">
                                                <td colspan="4" class="text-end"><strong>Grand Total:</strong></td>
                                                <td class="text-end">
                                                    <strong class="fs-5">{{ order.total_amount|currency }}</strong>
                                                </td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column: Status & Actions -->
                    <div class="col-md-4">
                        <!-- Order Status -->
                        <div class="card shadow-sm mb-4">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="bi bi-clipboard-check"></i> Order Status</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Current Status:</label>
                                    <div>
                                        {% if order.status == 'pending' %}
                                        <span class="badge bg-warning text-dark fs-6">
                                            <i class="bi bi-clock"></i> Pending
                                        </span>
                                        {% elif order.status == 'paid' %}
                                        <span class="badge bg-success fs-6">
                                            <i class="bi bi-check-circle"></i> Paid
                                        </span>
                                        {% elif order.status == 'delivered' %}
                                        <span class="badge bg-primary fs-6">
                                            <i class="bi bi-box-seam"></i> Delivered
                                        </span>
                                        {% elif order.status == 'cancelled' %}
                                        <span class="badge bg-danger fs-6">
                                            <i class="bi bi-x-circle"></i> Cancelled
                                        </span>
                                        {% endif %}
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label fw-bold">Delivery Type:</label>
                                    <div>
                                        {% if order.delivery_type == 'delivery' %}
                                        <span class="badge bg-info">
                                            <i class="bi bi-truck"></i> Delivery
                                        </span>
                                        {% else %}
                                        <span class="badge bg-secondary">
                                            <i class="bi bi-shop"></i> Pickup
                                        </span>
                                        {% endif %}
                                    </div>
                                </div>

                                <hr>

                                <div class="mb-3">
                                    <label for="status-select" class="form-label fw-bold">
                                        Update Status:
                                    </label>
                                    <select class="form-select" id="status-select">
                                        <option value="pending" {% if order.status == 'pending' %}selected{% endif %}>
                                            Pending
                                        </option>
                                        <option value="paid" {% if order.status == 'paid' %}selected{% endif %}>
                                            Paid
                                        </option>
                                        <option value="delivered" {% if order.status == 'delivered' %}selected{% endif %}>
                                            Delivered
                                        </option>
                                        <option value="cancelled" {% if order.status == 'cancelled' %}selected{% endif %}>
                                            Cancelled
                                        </option>
                                    </select>
                                </div>

                                <button class="btn btn-primary w-100" onclick="updateOrderStatus()">
                                    <i class="bi bi-save"></i> Update Status
                                </button>
                            </div>
                        </div>

                        <!-- Quick Actions -->
                        <div class="card shadow-sm">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="bi bi-lightning"></i> Quick Actions</h5>
                            </div>
                            <div class="card-body">
                                <div class="d-grid gap-2">
                                    <button class="btn btn-outline-primary" onclick="printOrder()">
                                        <i class="bi bi-printer"></i> Print Order
                                    </button>
                                    <button class="btn btn-outline-info" onclick="window.location.href='/orders'">
                                        <i class="bi bi-list-ul"></i> View All Orders
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
    <script>
        function updateOrderStatus() {
            const newStatus = document.getElementById('status-select').value;
            const orderId = {{ order.id }};
            
            if (!confirm(`Are you sure you want to change the status to "${newStatus}"?`)) {
                return;
            }
            
            fetch(`/api/orders/${orderId}/status`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ status: newStatus })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Order status updated successfully!');
                    location.reload();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while updating the status');
            });
        }

        function printOrder() {
            window.print();
        }
    </script>

    <style>
        @media print {
            .btn, .card-header, nav, aside {
                display: none !important;
            }
            .card {
                border: 1px solid #000 !important;
            }
        }
    </style>
{% endblock %}