{% extends "base.html" %}

{% block title %}Order Route{% endblock %}
{% block page_title %}Order Route{% endblock %}

{% block content %}
<div class="container-fluid h-100">
    <div class="row g-1">

        <!-- LEFT PANEL -->
        <aside class="col-md-4 col-lg-4">

            <!-- Date Filter -->
            <div class="mb-2">
                <input type="date"
                       id="route-date"
                       class="form-control"
                       value="{{ route_date }}"
                       onchange="loadOrders()">
            </div>

            <!-- Order List -->
            <ul class="list-group overflow-auto"
                id="order-list"
                style="max-height: calc(100vh - 220px);">

                <li class="list-group-item text-center text-muted">
                    <div class="spinner-border spinner-border-sm me-2"></div>
                    Loading orders...
                </li>

            </ul>
        </aside>

        <!-- MAP -->
        <div class="col-md-8 col-lg-8">
            <div class="position-relative">

                <!-- Map Controls -->
                <div class="position-absolute top-0 end-0 m-3 z-3">
                    <button class="btn btn-primary btn-sm shadow"
                            onclick="fitMapBounds()">
                        <i class="bi bi-fullscreen"></i> Fit All
                    </button>
                </div>

                <!-- Map -->
                <div id="map"
                     class="w-100 rounded border"
                     style="height: calc(100vh - 150px);">
                </div>

            </div>
        </div>

    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
/* =======================
   MAP INIT
======================= */
const depot = {
    lat: {{ depot.lat }},
    lng: {{ depot.lng }},
    name: "{{ depot.name }}"
};

const map = L.map('map').setView([depot.lat, depot.lng], 13);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19
}).addTo(map);

const depotIcon = L.icon({
    iconUrl: "{{ url_for('static', filename='icons/stockroom.png') }}",
    iconSize: [32, 32],
    iconAnchor: [16, 32]
});

const orderIcon = L.icon({
    iconUrl: "{{ url_for('static', filename='icons/placeholder.png') }}",
    iconSize: [32, 32],
    iconAnchor: [16, 32]
});

L.marker([depot.lat, depot.lng], { icon: depotIcon })
    .addTo(map)
    .bindPopup(`<b>${depot.name}</b><br>Starting Point`);

let markers = [];
let bounds = L.latLngBounds([[depot.lat, depot.lng]]);

/* =======================
   LOAD ORDERS
======================= */
function loadOrders() {
    const date = document.getElementById('route-date').value;

    fetch(`/api/order-route?date=${date}`)
        .then(res => res.json())
        .then(data => {
            renderOrders(data);
            renderMarkers(data);
        });
}

/* =======================
   RENDER ORDER LIST
======================= */
function renderOrders(orders) {
    const list = document.getElementById('order-list');
    list.innerHTML = '';

    if (!orders.length) {
        list.innerHTML = `
            <li class="list-group-item text-muted text-center">
                No orders found
            </li>`;
        return;
    }

    orders.forEach(o => {
        let productsHtml = '';
        let itemsTotal = 0;

        o.products.forEach(p => {
            const subtotal = p.quantity * p.sell_price;
            itemsTotal += subtotal;

            productsHtml += `
                <div class="small text-muted d-flex justify-content-between">
                    <span>
                        ${p.name} (${p.quantity} ${p.unit})
                        <br>
                        <small>@ ${formatCurrency(p.sell_price)}</small>
                    </span>
                    <span class="fw-semibold">
                        ${formatCurrency(subtotal)}
                    </span>
                </div>`;
        });

        const delivery = o.delivery_price || 0;

        const itemsTotalNum = parseFloat(itemsTotal) || 0;
        const deliveryNum   = parseFloat(o.delivery_price) || 0;

        const grandTotal = itemsTotalNum + deliveryNum;

        list.innerHTML += `
        <li class="list-group-item list-group-item-action mb-2 rounded shadow-sm"
            onclick="focusOrder(${o.latitude}, ${o.longitude})">

            <div class="fw-semibold">
                ${o.customer_name}
            </div>

            <div class="small text-muted mb-2">
                Order #${o.order_id} Â· ${o.status}
            </div>

            ${productsHtml}

            <hr class="my-2">

            <div class="small d-flex justify-content-between">
                <span>Items Total</span>
                <span>${formatCurrency(itemsTotal)}</span>
            </div>

            <div class="small d-flex justify-content-between">
                <span>Delivery</span>
                <span>${formatCurrency(delivery)}</span>
            </div>

            <div class="fw-semibold d-flex justify-content-between mt-1">
                <span>Total</span>
                <span>${formatCurrency(grandTotal)}</span>
            </div>

        </li>`;
    });
}

/* =======================
   RENDER MARKERS
======================= */
function renderMarkers(orders) {
    markers.forEach(m => map.removeLayer(m));
    markers = [];

    bounds = L.latLngBounds([[depot.lat, depot.lng]]);

    orders.forEach(o => {
        const marker = L.marker([o.latitude, o.longitude], {
            icon: orderIcon
        }).addTo(map)
                .bindTooltip(
            o.customer_name,
            {
                permanent: true,
                direction: 'top',
                offset: [0, -30],
                className: 'customer-label'
            }
        );

        markers.push(marker);
        bounds.extend([o.latitude, o.longitude]);
    });

    fitMapBounds();
}

/* =======================
   HELPERS
======================= */
function focusOrder(lat, lng) {
    map.setView([lat, lng], 16);
}

function fitMapBounds() {
    if (bounds.isValid()) {
        map.fitBounds(bounds, { padding: [40, 40] });
    }
}

function formatCurrency(value) {
    return new Intl.NumberFormat('id-ID', {
        style: 'currency',
        currency: 'IDR'
    }).format(value);
}

/* INIT */
loadOrders();
</script>
{% endblock %}
