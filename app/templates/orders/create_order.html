{% extends "base.html" %}

{% block title %}Create Order{% endblock %}
{% block page_title %}Create New Order{% endblock %}

{% block content %}
    <div class="container-fluid py-4">
        <div class="row">
            <div class="col-lg-12 mx-auto">
                <div class="shadow-sm">
                    <div class="card-body">
                        <form id="order-form">
                            <div class="mb-4">
                                <label for="order_date" class="form-label fw-bold">
                                    Order Date <span class="text-danger">*</span>
                                </label>
                                <input type="datetime-local"
                                    class="form-control"
                                    id="order_date"
                                    name="order_date"
                                    required>
                            </div>
                            <div class="mb-4">
                                <label for="customer_id" class="form-label fw-bold">
                                    Customer <span class="text-danger">*</span>
                                </label>
                                <select class="form-select" id="customer_id" name="customer_id" required>
                                    <option value="">Select a customer...</option>
                                    {% for customer in customers %}
                                    <option value="{{ customer.id }}">
                                        {{ customer.name }} - {{ customer.phone or 'No phone' }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>

                            <!-- Delivery Type -->
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <label for="delivery_type" class="form-label fw-bold">Delivery Type</label>
                                    <select class="form-select" id="delivery_type" name="delivery_type">
                                        <option value="pickup">Pickup</option>
                                        <option value="delivery">Delivery</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="delivery_price" class="form-label fw-bold">Delivery Price</label>
                                    <input type="number" class="form-control" id="delivery_price" 
                                        name="delivery_price" value="0" min="0" step="0.01">
                                </div>
                            </div>

                            <!-- Order Items -->
                            <div class="mb-4">
                                <label class="form-label fw-bold">
                                    Order Items <span class="text-danger">*</span>
                                </label>
                                <div id="order-items">
                                    <!-- Items will be added here -->
                                </div>
                                <button type="button" class="btn btn-outline-secondary btn-sm mt-2" 
                                        onclick="addOrderItem()">
                                    <i class="bi bi-plus-circle"></i> Add Item
                                </button>
                            </div>

                            <!-- Total -->
                            <div class="mb-4 p-3 bg-light rounded">
                                <div class="row">
                                    <div class="col-6">
                                        <strong>Subtotal:</strong>
                                    </div>
                                    <div class="col-6 text-end">
                                        <span id="subtotal">Rp 0</span>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-6">
                                        <strong>Delivery:</strong>
                                    </div>
                                    <div class="col-6 text-end">
                                        <span id="delivery-display">Rp 0</span>
                                    </div>
                                </div>
                                <hr>
                                <div class="row">
                                    <div class="col-6">
                                        <strong class="fs-5">Total:</strong>
                                    </div>
                                    <div class="col-6 text-end">
                                        <strong class="fs-5 text-primary" id="total">Rp 0</strong>
                                    </div>
                                </div>
                            </div>

                            <!-- Status -->
                            <div class="mb-4">
                                <label for="status" class="form-label fw-bold">Order Status</label>
                                <select class="form-select" id="status" name="status">
                                    <option value="pending">Pending</option>
                                    <option value="paid">Paid</option>
                                    <option value="delivered">Delivered</option>
                                </select>
                            </div>

                            <!-- Submit Buttons -->
                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-primary">
                                    Create Order
                                </button>
                                <a href="{{ url_for('orders.list') }}" class="btn btn-outline-secondary">
                                    Cancel
                                </a>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
    <script>
        const products = {{ products|tojson }};
        let itemCounter = 0;

        function formatCurrency(amount) {
            return 'Rp ' + parseFloat(amount).toLocaleString('id-ID', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            });
        }

        function addOrderItem() {
            itemCounter++;
            const itemHtml = `
                <div class="border rounded p-3 mb-2 bg-white shadow-sm order-item" id="item-${itemCounter}">
                    <div class="card-body">
                        <div class="row g-2">
                            <div class="col-md-4">
                                <label class="form-label small">Product</label>
                                <select class="form-select form-select-sm product-select" 
                                        data-item="${itemCounter}" required>
                                    <option value="">Select product...</option>
                                    ${products.map(p => `
                                        <option value="${p.id}" 
                                                data-buy-price="${p.buy_price}" 
                                                data-sell-price="${p.sell_price}"
                                                data-unit="${p.unit}"
                                                data-stock="${p.stock}">
                                            ${p.name} (Stock: ${p.stock} ${p.unit})
                                        </option>
                                    `).join('')}
                                </select>
                            </div>
                            <div class="col-md-1">
                                <label class="form-label small">Quantity</label>
                                <input type="number" class="form-control form-control-sm quantity-input" 
                                    data-item="${itemCounter}" min="0.01" step="0.01" value="1" required>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label small">Buy Price</label>
                                <input type="number" class="form-control form-control-sm buy-price" 
                                    data-item="${itemCounter}" readonly>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label small">Sell Price</label>
                                <input type="number" class="form-control form-control-sm sell-price" 
                                    data-item="${itemCounter}" min="0" step="0.01" required>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label small">Subtotal</label>
                                <input type="text" class="form-control form-control-sm item-subtotal" 
                                    data-item="${itemCounter}" readonly>
                            </div>
                            <div class="col-md-1">
                                <label class="form-label small">&nbsp;</label>
                                <button type="button" class="btn btn-sm btn-danger w-100" 
                                        onclick="removeOrderItem(${itemCounter})">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('order-items').insertAdjacentHTML('beforeend', itemHtml);
            
            // Add event listeners
            const item = document.querySelector(`#item-${itemCounter}`);
            const productSelect = item.querySelector('.product-select');
            const quantityInput = item.querySelector('.quantity-input');
            const sellPriceInput = item.querySelector('.sell-price');
            
            productSelect.addEventListener('change', function() {
                updateItemPrices(itemCounter);
            });
            
            quantityInput.addEventListener('input', function() {
                updateItemSubtotal(itemCounter);
            });
            
            sellPriceInput.addEventListener('input', function() {
                updateItemSubtotal(itemCounter);
            });
        }

        function updateItemPrices(itemId) {
            const item = document.querySelector(`#item-${itemId}`);
            const select = item.querySelector('.product-select');
            const option = select.options[select.selectedIndex];
            
            if (option.value) {
                const buyPrice = option.getAttribute('data-buy-price');
                const sellPrice = option.getAttribute('data-sell-price');
                
                item.querySelector('.buy-price').value = buyPrice;
                item.querySelector('.sell-price').value = sellPrice;
                
                updateItemSubtotal(itemId);
            }
        }

        function updateItemSubtotal(itemId) {
            const item = document.querySelector(`#item-${itemId}`);
            const quantity = parseFloat(item.querySelector('.quantity-input').value) || 0;
            const sellPrice = parseFloat(item.querySelector('.sell-price').value) || 0;
            const subtotal = quantity * sellPrice;
            
            item.querySelector('.item-subtotal').value = formatCurrency(subtotal);
            
            calculateTotal();
        }

        function removeOrderItem(itemId) {
            document.getElementById(`item-${itemId}`).remove();
            calculateTotal();
        }

        function calculateTotal() {
            let subtotal = 0;
            
            document.querySelectorAll('.order-item').forEach(item => {
                const quantity = parseFloat(item.querySelector('.quantity-input').value) || 0;
                const sellPrice = parseFloat(item.querySelector('.sell-price').value) || 0;
                subtotal += quantity * sellPrice;
            });
            
            const deliveryPrice = parseFloat(document.getElementById('delivery_price').value) || 0;
            const total = subtotal + deliveryPrice;
            
            document.getElementById('subtotal').textContent = formatCurrency(subtotal);
            document.getElementById('delivery-display').textContent = formatCurrency(deliveryPrice);
            document.getElementById('total').textContent = formatCurrency(total);
        }

        // Event listener for delivery price
        document.getElementById('delivery_price').addEventListener('input', calculateTotal);

        // Form submission
        document.getElementById('order-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const items = [];
            const orderItems = document.querySelectorAll('.order-item');
            
            if (orderItems.length === 0) {
                alert('Please add at least one item to the order');
                return;
            }
            
            orderItems.forEach(item => {
                const productSelect = item.querySelector('.product-select');
                const productId = productSelect.value;
                
                if (!productId) {
                    alert('Please select a product for all items');
                    return;
                }
                
                items.push({
                    product_id: parseInt(productId),
                    quantity: parseFloat(item.querySelector('.quantity-input').value),
                    buy_price: parseFloat(item.querySelector('.buy-price').value),
                    sell_price: parseFloat(item.querySelector('.sell-price').value)
                });
            });
            
            const orderData = {
                order_date: document.getElementById('order_date').value,
                customer_id: parseInt(document.getElementById('customer_id').value),
                delivery_type: document.getElementById('delivery_type').value,
                delivery_price: parseFloat(document.getElementById('delivery_price').value) || 0,
                status: document.getElementById('status').value,
                items: items
            };
            
            fetch('/api/orders', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(orderData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Order created successfully!');
                    window.location.href = '/orders/' + data.order_id;
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while creating the order');
            });
        });

        document.addEventListener('DOMContentLoaded', () => {
    const now = new Date();
    now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
    document.getElementById('order_date').value = now.toISOString().slice(0, 16);
});
        // Add first item on page load
        addOrderItem();
    </script>
{% endblock %}