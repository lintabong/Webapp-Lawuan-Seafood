{% extends "base.html" %}

{% block title %}Orders{% endblock %}
{% block page_title %}Orders{% endblock %}

{% block content %}
    <div class="card p-3 mb-4">
        <div class="row g-3">
            <div class="col-md-4">
                <input type="text" id="searchInput" class="form-control" placeholder="Search customer name...">
            </div>
            <div class="col-md-3">
                <select id="statusFilter" class="form-select">
                    <option value="all">All Status</option>
                    <option value="pending">Pending</option>
                    <option value="paid">Paid</option>
                    <option value="delivered">Delivered</option>
                    <option value="cancelled">Cancelled</option>
                </select>
            </div>
            <div class="col-md-2">
                <select id="perPageSelect" class="form-select">
                    <option value="10">10 per page</option>
                    <option value="25" selected>25 per page</option>
                    <option value="50">50 per page</option>
                    <option value="100">100 per page</option>
                </select>
            </div>
            <div class="col-md-3">
                <button class="btn btn-primary w-100" onclick="loadOrders()">
                    <i class="bi bi-search"></i> Search
                </button>
            </div>
        </div>
    </div>

    <div id="ordersLoading">
        <div class="card p-3 mb-3">
            <div class="skeleton skeleton-lg mb-2"></div>
            <div class="skeleton"></div>
        </div>
        <div class="card p-3 mb-3">
            <div class="skeleton skeleton-lg mb-2"></div>
            <div class="skeleton"></div>
        </div>
    </div>

    <!-- Orders list -->
    <div id="ordersList" class="hidden"></div>

    <!-- Pagination -->
    <nav id="paginationNav" class="hidden mt-4" aria-label="Orders pagination">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
                <small class="text-muted" id="paginationInfo"></small>
            </div>
            <ul class="pagination mb-0" id="paginationList"></ul>
        </div>
    </nav>

    <!-- Empty state -->
    <div id="emptyState" class="hidden text-center py-5">
        <i class="bi bi-inbox" style="font-size: 3rem; color: #ccc;"></i>
        <p class="text-muted mt-3">No orders found</p>
    </div>
{% endblock %}

{% block extra_js %}
    <script>
        let currentPage = 1;
        let totalCount = 0;

        function formatRupiah(amount) {
            return new Intl.NumberFormat('id-ID').format(amount);
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('id-ID', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function getStatusBadge(status) {
            const badges = {
                'pending': 'bg-warning',
                'paid': 'bg-info',
                'delivered': 'bg-success',
                'cancelled': 'bg-danger'
            };
            return badges[status] || 'bg-secondary';
        }

        function getStatusText(status) {
            const texts = {
                'pending': 'Pending',
                'paid': 'Paid',
                'delivered': 'Delivered',
                'cancelled': 'Cancelled'
            };
            return texts[status] || status;
        }

        async function updateOrderStatus(orderId, newStatus, selectElement) {
            const originalStatus = selectElement.value;

            try {
                selectElement.disabled = true;

                const response = await fetch(`/api/orders/${orderId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status: newStatus })
                });

                if (!response.ok) throw new Error('Failed to update status');

                const card = selectElement.closest('.card');
                const badge = card.querySelector('.order-status-badge');
                badge.className = `badge ${getStatusBadge(newStatus)} order-status-badge`;
                badge.textContent = getStatusText(newStatus);

                showToast('Status updated successfully', 'success');

            } catch (error) {
                console.error('Error updating status:', error);
                selectElement.value = originalStatus;
                showToast('Failed to update status', 'error');
            } finally {
                selectElement.disabled = false;
            }
        }

        async function updateItemPrepared(itemId, isPrepared, checkboxElement) {
            const originalValue = checkboxElement.checked;

            try {
                checkboxElement.disabled = true;

                const response = await fetch(`/api/order-items/${itemId}/prepared`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ is_prepared: isPrepared })
                });

                if (!response.ok) throw new Error('Failed to update item status');

                showToast('Item status updated', 'success');

            } catch (error) {
                console.error('Error updating item:', error);
                checkboxElement.checked = originalValue;
                showToast('Failed to update item status', 'error');
            } finally {
                checkboxElement.disabled = false;
            }
        }

        function showToast(message, type) {
            const toast = document.createElement('div');
            toast.className = `alert alert-${type === 'success' ? 'success' : 'danger'} position-fixed top-0 end-0 m-3`;
            toast.style.zIndex = '9999';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => toast.remove(), 3000);
        }

        function renderPagination(page, perPage, total) {
            const totalPages = Math.ceil(total / perPage);
            const paginationNav = document.getElementById('paginationNav');
            const paginationList = document.getElementById('paginationList');
            const paginationInfo = document.getElementById('paginationInfo');

            if (totalPages <= 1) {
                paginationNav.classList.add('hidden');
                return;
            }

            paginationNav.classList.remove('hidden');

            const start = (page - 1) * perPage + 1;
            const end = Math.min(page * perPage, total);
            paginationInfo.textContent = `Showing ${start}-${end} of ${total} orders`;

            let html = '';

            html += `
                <li class="page-item ${page === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${page - 1}); return false;">
                        <i class="bi bi-chevron-left"></i>
                    </a>
                </li>
            `;

            const maxVisible = 5;
            let startPage = Math.max(1, page - Math.floor(maxVisible / 2));
            let endPage = Math.min(totalPages, startPage + maxVisible - 1);
            
            if (endPage - startPage < maxVisible - 1) {
                startPage = Math.max(1, endPage - maxVisible + 1);
            }

            if (startPage > 1) {
                html += `
                    <li class="page-item">
                        <a class="page-link" href="#" onclick="changePage(1); return false;">1</a>
                    </li>
                `;
                if (startPage > 2) {
                    html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                }
            }

            for (let i = startPage; i <= endPage; i++) {
                html += `
                    <li class="page-item ${i === page ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="changePage(${i}); return false;">${i}</a>
                    </li>
                `;
            }

            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                }
                html += `
                    <li class="page-item">
                        <a class="page-link" href="#" onclick="changePage(${totalPages}); return false;">${totalPages}</a>
                    </li>
                `;
            }

            html += `
                <li class="page-item ${page === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${page + 1}); return false;">
                        <i class="bi bi-chevron-right"></i>
                    </a>
                </li>
            `;
            
            paginationList.innerHTML = html;
        }

        function changePage(page) {
            currentPage = page;
            loadOrders();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        async function loadOrders() {
            const loadingEl = document.getElementById('ordersLoading');
            const listEl = document.getElementById('ordersList');
            const emptyEl = document.getElementById('emptyState');
            const paginationNav = document.getElementById('paginationNav');
            
            try {
                loadingEl.classList.remove('hidden');
                listEl.classList.add('hidden');
                emptyEl.classList.add('hidden');
                paginationNav.classList.add('hidden');
                
                const status = document.getElementById('statusFilter').value;
                const search = document.getElementById('searchInput').value;
                const perPage = parseInt(document.getElementById('perPageSelect').value);

                const params = new URLSearchParams();
                if (status !== 'all') params.append('status', status);
                if (search) params.append('search', search);
                params.append('page', currentPage);
                params.append('per_page', perPage);

                const response = await fetch(`/api/orders?${params}`);
                const data = await response.json();

                loadingEl.classList.add('hidden');

                if (data.orders.length === 0) {
                    emptyEl.classList.remove('hidden');
                    return;
                }

                totalCount = data.total;

                listEl.innerHTML = data.orders.map(order => `
                    <div class="card mb-3" id="order-${order.id}">
                        <div class="card-body">
                            <!-- Order Header -->
                            <div class="d-flex justify-content-between align-items-start mb-3 pb-3 border-bottom">
                                <div>
                                    <h5 class="card-title mb-1">
                                        <i class="bi bi-receipt"></i> Order #${order.id}
                                    </h5>
                                    <small class="text-muted">${formatDate(order.order_date)}</small>
                                </div>
                                <div class="d-flex gap-2 align-items-center">
                                    ${order.status === 'pending' ? `
                                        <a href="/orders/edit?id=${order.id}" 
                                           class="btn btn-warning btn-sm" 
                                           title="Edit Order">
                                            <i class="bi bi-pencil"></i> Edit
                                        </a>
                                    ` : ''}
                                    <span class="badge ${getStatusBadge(order.status)} order-status-badge">
                                        ${getStatusText(order.status)}
                                    </span>
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <p class="mb-1">
                                        <i class="bi bi-person"></i> 
                                        <strong>${order.customers.name}</strong>
                                    </p>
                                    ${order.customers.phone ? `
                                        <p class="mb-1 text-muted">
                                            <i class="bi bi-telephone"></i> ${order.customers.phone}
                                        </p>
                                    ` : ''}
                                    ${order.customers.address ? `
                                        <p class="mb-1 text-muted">
                                            <i class="bi bi-geo-alt"></i> ${order.customers.address}
                                        </p>
                                    ` : ''}
                                </div>
                                <div class="col-md-6 text-md-end">
                                    <span class="badge bg-secondary">
                                        ${order.delivery_type === 'delivery' ? 
                                            '<i class="bi bi-truck"></i> Delivery' : 
                                            '<i class="bi bi-bag"></i> Pickup'}
                                    </span>
                                </div>
                            </div>

                            <!-- Order Items Table -->
                            <div class="table-responsive mb-3">
                                <table class="table table-sm table-hover mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th width="40">
                                                <i class="bi bi-check-square"></i>
                                            </th>
                                            <th>Product</th>
                                            <th class="text-center">Quantity</th>
                                            <th class="text-end">Unit Price</th>
                                            <th class="text-end">Subtotal</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${order.order_items.map(item => `
                                            <tr>
                                                <td class="text-center align-middle">
                                                    <input type="checkbox" 
                                                           class="form-check-input" 
                                                           ${item.is_prepared ? 'checked' : ''}
                                                           onchange="updateItemPrepared(${item.id}, this.checked, this)"
                                                           ${order.status === 'cancelled' || order.status === 'delivered' ? 'disabled' : ''}>
                                                </td>
                                                <td class="align-middle">
                                                    <strong>${item.products.name}</strong>
                                                </td>
                                                <td class="text-center align-middle">
                                                    ${item.quantity} ${item.products.unit}
                                                </td>
                                                <td class="text-end align-middle">
                                                    Rp ${formatRupiah(item.sell_price)}
                                                </td>
                                                <td class="text-end align-middle">
                                                    <strong>Rp ${formatRupiah(item.sell_price * item.quantity)}</strong>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                    <tfoot class="table-light">
                                        ${order.delivery_price > 0 ? `
                                            <tr>
                                                <td colspan="4" class="text-end">Delivery Fee:</td>
                                                <td class="text-end">Rp ${formatRupiah(order.delivery_price)}</td>
                                            </tr>
                                        ` : ''}
                                        <tr>
                                            <td colspan="4" class="text-end"><strong>Total:</strong></td>
                                            <td class="text-end">
                                                <strong class="text-primary">Rp ${formatRupiah(order.total_amount + order.delivery_price)}</strong>
                                            </td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>

                            <!-- Status Update -->
                            <div class="row">
                                <div class="col-md-4">
                                    <label class="form-label mb-2">
                                        <small class="text-muted">Update Order Status:</small>
                                    </label>
                                    <select class="form-select form-select-sm" 
                                            onchange="updateOrderStatus(${order.id}, this.value, this)"
                                            ${order.status === 'cancelled' || order.status === 'delivered' ? 'disabled' : ''}>
                                        <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>Pending</option>
                                        <option value="paid" ${order.status === 'paid' ? 'selected' : ''}>Paid</option>
                                        <option value="delivered" ${order.status === 'delivered' ? 'selected' : ''}>Delivered</option>
                                        <option value="cancelled" ${order.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
                
                listEl.classList.remove('hidden');

                renderPagination(currentPage, perPage, totalCount);
                
            } catch (error) {
                console.error('Error loading orders:', error);
                loadingEl.classList.add('hidden');
                showToast('Failed to load orders', 'error');
            }
        }

        document.addEventListener('DOMContentLoaded', loadOrders);

        document.getElementById('searchInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                currentPage = 1;
                loadOrders();
            }
        });

        document.getElementById('statusFilter').addEventListener('change', () => {
            currentPage = 1;
            loadOrders();
        });

        document.getElementById('perPageSelect').addEventListener('change', () => {
            currentPage = 1;
            loadOrders();
        });
    </script>
{% endblock %}
